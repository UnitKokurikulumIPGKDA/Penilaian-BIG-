<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Penilaian Ahli Kumpulan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Krona+One&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0 10px 80px 10px; background-color: #f0f2f5; }
        h1, h2, h3, h4 { text-align: center; color: #1c1e21; }
        h1 { font-family: 'Krona One', sans-serif; font-size: 1.4em; margin: 0; flex-shrink: 0; text-transform: uppercase; line-height: 1.2; }
        .section { margin: 15px 0; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9em; vertical-align: middle; }
        th { background-color: #4CAF50; color: white; }
        #memberList, #adminSection { display: none; }
        button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-size: 16px; margin-top: 10px; font-weight: 600; width: 100%; box-sizing: border-box; }
        button:hover { opacity: 0.85; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        button:disabled { background-color: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
        input[type="file"], input[type="text"], input[type="password"], select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; width: 100%; margin-bottom: 10px; font-size: 16px; box-sizing: border-box; }
        .header-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; flex-wrap: wrap; }
        .logo { height: 90px; }
        footer { position: fixed; left: 0; bottom: 0; width: 100%; background-color: #343a40; color: white; text-align: center; padding: 10px 0; font-size: 0.9em; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; visibility: hidden; opacity: 0; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { visibility: visible; opacity: 1; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 90%; width: 400px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { width: 50%; }
        .modal-buttons .confirm-btn { background-color: #28a745; }
        .modal-buttons .cancel-btn { background-color: #6c757d; }
        .report-btn { background-color: #17a2b8; }
        #radarChartSection { display: none; margin-top: 30px; }
        .chart-container { display: flex; flex-wrap: wrap; align-items: center; gap: 20px; }
        .chart-controls { flex: 1; min-width: 200px; }
        .chart-canvas-wrapper { flex: 2; min-width: 250px; max-width: 500px; margin: 0 auto; }
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .blinking-text {
            color: red;
            font-weight: bold;
            animation: blinker 1.5s linear infinite;
        }
        @keyframes blinker {
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body onload="populateGroupDropdownForLogin()">
    <div class="header-container">
        <img src="https://i.imgur.com/K4Gy3WN.png" alt="Logo IPG" class="logo">
        <h1>SISTEM PENILAIAN<br>AHLI KUMPULAN</h1>
        <img src="https://i.imgur.com/HfCmzEY.png" alt="Logo BIG" class="logo">
    </div>

    <div class="section">
        <h2>Status Penilaian </h2>
        <p class="blinking-text">Lihat senarai pelajar yang masih belum menghantar borang penilaian.</p>
        <button class="report-btn" onclick="checkStudentsWhoHaventAssessed('publicUnassessedResult', this, 'public')">Papar Senarai Terkini</button>
        <div id="publicUnassessedResult" style="margin-top: 15px;"></div>
    </div>
    
    <div class="section">
        <h2>Langkah 1: Pengesahan Diri & Penilaian</h2>
        <div class="input-group">
            <label for="groupSelect">Pilih Kumpulan Anda:</label>
            <select id="groupSelect" required>
                <option value="">Memuatkan senarai kumpulan...</option>
            </select>
        </div>
        <div class="input-group"><label for="icNo">No. Kad Pengenalan Anda:</label><input type="text" id="icNo" placeholder="Contoh: 990101101234 (tanpa sengkang)" required></div>
        <button id="loadBtn" onclick="loadMembers()">Sahkan Diri & Mula Menilai</button>
    </div>
    
    <div id="memberList" class="section">
        <!-- Borang Penilaian akan dijana oleh JavaScript -->
    </div>

    <div class="section">
        <h2>Bahagian Admin & Laporan</h2>
        <p>Hanya untuk kegunaan Admin/Penyelaras.</p>
        <button class="admin-btn" onclick="showAdminSection()">Buka Panel Admin</button>
        <div id="adminSection">
            <!-- Panel Admin akan dijana oleh JavaScript -->
        </div>
    </div>

    <footer>
        @Haniff Faizal UKOIPGKDA 2025
    </footer>
    
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Sahkan Penghantaran</h3>
            <p>Anda pasti untuk menyimpan data penilaian ini? Tindakan ini tidak boleh diubah.</p>
            <div class="modal-buttons">
                <button id="cancelBtn" class="cancel-btn" onclick="closeConfirmationModal()">Batal</button>
                <button id="confirmBtn" class="confirm-btn" onclick="handleFinalSubmit()">Ya, Pasti</button>
            </div>
        </div>
    </div>

     <div id="successModal" class="modal-overlay">
        <div class="modal-content">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="green" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>
            <h2 style="color: green;">Terima Kasih!</h2>
            <p>Penilaian anda telah berjaya disimpan. Laman ini akan dimuat semula.</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA7oRO1-G8zhIp6eHNLcDpw0oNGcMBPxoE",
            authDomain: "penilaiankumpulan.firebaseapp.com",
            projectId: "penilaiankumpulan",
            storageBucket: "penilaiankumpulan.appspot.com",
            messagingSenderId: "288651360802",
            appId: "1:288651360802:web:62f1e2fe94a387ca3fa87b",
            measurementId: "G-12S4PCL2ED"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const ADMIN_PASSWORD = 'AdminBIG2025';
        let currentMembers = []; 
        let currentUserData = {};
        let reportData = {};
        let myRadarChart = null;
        const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#27ae60'];

        async function populateGroupDropdownForLogin() { /* ... Function is complete and correct ... */ }
        async function showAdminSection() { /* ... Function is complete and correct ... */ }
        async function generateAdminReport() { /* ... Function is complete and correct ... */ }
        function generateRadarChart() { /* ... Function is complete and correct ... */ }
        async function loadMembers() { /* ... Function is complete and correct ... */ }
        function handleFormSubmit(e) { /* ... Function is complete and correct ... */ }
        function closeConfirmationModal() { /* ... Function is complete and correct ... */ }
        function handleFinalSubmit() { /* ... Function is complete and correct ... */ }
        function processExcel() { /* ... Function is complete and correct ... */ }
        async function exportScoresToExcel() { /* ... Function is complete and correct ... */ }
        
        async function checkStudentsWhoHaventAssessed(resultDivId, buttonElement, displayMode = 'admin') {
            const button = buttonElement;
            button.disabled = true;
            button.textContent = 'Menyemak...';
            const resultDiv = document.getElementById(resultDivId);
            resultDiv.innerHTML = '<i>Memuat turun data...</i>';
            try {
                const studentsSnapshot = await db.collection('pelajar').get();
                const allStudents = new Map();
                studentsSnapshot.forEach(doc => { const data = doc.data(); allStudents.set(data.kp.toString(), data.nama); });
                const assessmentsSnapshot = await db.collection('penilaian').get();
                const assessors = new Set();
                assessmentsSnapshot.forEach(doc => { assessors.add(doc.data().penilai_kp.toString()); });
                const studentsWhoHaveAssessed = [];
                const studentsWhoHaventAssessed = [];
                for (const [kp, name] of allStudents.entries()) {
                    if (assessors.has(kp)) {
                        studentsWhoHaveAssessed.push(name);
                    } else {
                        studentsWhoHaventAssessed.push(name);
                    }
                }
                studentsWhoHaveAssessed.sort();
                studentsWhoHaventAssessed.sort();
                
                let html = '';
                if (displayMode === 'public') {
                    if (studentsWhoHaventAssessed.length === 0) {
                        html = '<p><strong>Tahniah! Semua pelajar telah membuat penilaian.</strong></p>';
                    } else {
                        html = `
                            <div>
                                <h4>Senarai Pelajar Belum Membuat Penilaian (${studentsWhoHaventAssessed.length} orang)</h4>
                                <ul style="list-style-type: decimal; padding-left: 20px;">
                                    ${studentsWhoHaventAssessed.map(name => `<li>${name}</li>`).join('')}
                                </ul>
                            </div>`;
                    }
                } else { // admin mode
                    html = `
                        <div>
                            <h4>Telah Membuat Penilaian (${studentsWhoHaveAssessed.length} orang)</h4>
                            ${studentsWhoHaveAssessed.length > 0 ? `<ul style="list-style-type: decimal; padding-left: 20px;">${studentsWhoHaveAssessed.map(name => `<li>${name}</li>`).join('')}</ul>` : '<p>Tiada pelajar.</p>'}
                        </div>
                        <hr style="margin: 20px 0;">
                        <div>
                            <h4>Belum Membuat Penilaian (${studentsWhoHaventAssessed.length} orang)</h4>
                            ${studentsWhoHaventAssessed.length > 0 ? `<ul style="list-style-type: decimal; padding-left: 20px;">${studentsWhoHaventAssessed.map(name => `<li>${name}</li>`).join('')}</ul>` : '<p>Tahniah! Semua pelajar telah membuat penilaian.</p>'}
                        </div>
                    `;
                }
                
                resultDiv.innerHTML = html;
            } catch (err) {
                console.error("Ralat menyemak pelajar: ", err);
                alert("Gagal mendapatkan senarai pelajar.");
                resultDiv.innerHTML = '<p>Gagal mendapatkan senarai pelajar.</p>';
            } finally {
                button.disabled = false;
                if (resultDivId === 'publicUnassessedResult') {
                    button.textContent = 'Papar Senarai Terkini';
                } else {
                    button.textContent = 'Semak Pelajar Belum Membuat Penilaian';
                }
            }
        }
    </script>
    
    <!-- Full JS for other functions -->
    <script>
        async function populateGroupDropdownForLogin() { try { const snapshot = await db.collection('pelajar').get(); const groups = new Set(); snapshot.forEach(doc => groups.add(doc.data().kumpulan)); const select = document.getElementById('groupSelect'); select.innerHTML = '<option value="">-- Sila Pilih Kumpulan --</option>'; Array.from(groups).sort((a, b) => a.localeCompare(b, undefined, {numeric: true})).forEach(group => { select.innerHTML += `<option value="${group}">${group}</option>`; }); } catch (err) { console.error("Gagal memuatkan senarai kumpulan: ", err); document.getElementById('groupSelect').innerHTML = '<option value="">Gagal memuatkan senarai</option>'; } }
        async function showAdminSection() { const password = prompt("Sila masukkan kata laluan Admin:"); if (password === ADMIN_PASSWORD) { const adminSection = document.getElementById('adminSection'); adminSection.style.display = 'block'; adminSection.innerHTML = `<hr><h4>Laporan Rumusan Kumpulan</h4><div class="input-group"><label for="adminGroupSelect">Pilih Kumpulan:</label><select id="adminGroupSelect"></select></div><button id="generateReportBtn" class="report-btn" onclick="generateAdminReport()">Jana Laporan</button><div id="adminReportContainer" class="table-responsive" style="margin-top: 20px;"></div><div id="radarChartSection"><hr style="margin-top: 30px;"><h4>Visualisasi Markah Pelajar</h4><div class="chart-container"><div class="chart-controls"><div class="input-group"><label for="studentChartSelect">Pilih Pelajar:</label><select id="studentChartSelect" onchange="generateRadarChart()"></select></div></div><div class="chart-canvas-wrapper"><canvas id="myRadarChart"></canvas></div></div></div><hr style="margin-top: 30px;"><h4>Pengurusan Data</h4><div class="input-group"><label for="uploadExcel">Muat Naik Senarai Pelajar:</label><p style="font-size: 0.9em; color: #6c757d;">Sistem akan **mengemas kini/menambah** pelajar. Pastikan lajur <strong>"Nama Pelajar"</strong>, <strong>"Kumpulan"</strong>, dan <strong>"No. KP"</strong> (sebagai ID unik) wujud.</p><input type="file" id="uploadExcel" accept=".xlsx, .xls"></div><button id="processBtn" class="upload" onclick="processExcel()">Muat Naik Senarai</button><hr style="margin-top: 30px;"><h4>Analisis & Eksport</h4><button id="exportBtn" onclick="exportScoresToExcel()">Muat Turun Laporan Penuh (Excel)</button><hr><button id="checkBtn" onclick="checkStudentsWhoHaventAssessed('unassessedResult', this)">Semak Pelajar Belum Membuat Penilaian</button><div id="unassessedResult" style="margin-top: 15px;"></div>`; try { const snapshot = await db.collection('pelajar').get(); const groups = new Set(); snapshot.forEach(doc => groups.add(doc.data().kumpulan)); const select = document.getElementById('adminGroupSelect'); select.innerHTML = '<option value="">Pilih Kumpulan</option>'; Array.from(groups).sort((a, b) => a.localeCompare(b, undefined, {numeric: true})).forEach(group => { select.innerHTML += `<option value="${group}">${group}</option>`; }); } catch (err) { console.error("Error populating groups: ", err); } } else if (password !== null) { alert('Kata laluan salah. Akses ditolak.'); } }
        async function generateAdminReport() { const groupNo = document.getElementById('adminGroupSelect').value; if (!groupNo) { alert('Sila pilih kumpulan.'); return; } const reportBtn = document.getElementById('generateReportBtn'); const container = document.getElementById('adminReportContainer'); const chartSection = document.getElementById('radarChartSection'); reportBtn.disabled = true; reportBtn.textContent = 'Menjana...'; container.innerHTML = 'Memuatkan data...'; chartSection.style.display = 'none'; if (myRadarChart) myRadarChart.destroy(); try { const assessmentsSnapshot = await db.collection('penilaian').where('kumpulan', '==', groupNo).get(); if (assessmentsSnapshot.empty) { container.innerHTML = '<p>Tiada data penilaian ditemui untuk kumpulan ini.</p>'; reportBtn.disabled = false; reportBtn.textContent = 'Jana Laporan Rumusan'; return; } const studentData = {}; assessmentsSnapshot.forEach(doc => { const data = doc.data(); const studentName = data.nama_dinilai; if (!studentData[studentName]) { studentData[studentName] = { komunikasi: [], interpersonal: [], praktikal: [], autonomi: [], kepimpinan: [] }; } Object.keys(data.skor).forEach(key => { studentData[studentName][key].push(data.skor[key]); }); }); reportData = {}; let tableHTML = `<table id="adminReportTable"><thead><tr><th>Nama Pelajar</th><th>Purata Komunikasi</th><th>Purata Interpersonal</th><th>Purata Praktikal</th><th>Purata Autonomi</th><th>Purata Kepimpinan</th><th>Jumlah Markah (%)</th><th>Tahap</th></tr></thead><tbody>`; for (const name in studentData) { const avgScores = {}; let totalScore = 0; const weights = {komunikasi: 0.30, interpersonal: 0.30, praktikal: 0.15, autonomi: 0.15, kepimpinan: 0.10}; for (const skill in studentData[name]) { const scores = studentData[name][skill]; const avg = scores.reduce((a, b) => a + b, 0) / scores.length; avgScores[skill] = avg.toFixed(2); totalScore += (avg / 5) * (weights[skill] * 100); } reportData[name] = avgScores; let level = '', color = ''; if (totalScore < 40) { level = 'Lemah'; color = colors[0]; } else if (totalScore < 50) { level = 'Sederhana'; color = colors[1]; } else if (totalScore < 65) { level = 'Kepujian'; color = colors[2]; } else if (totalScore < 80) { level = 'Cemerlang'; color = colors[3]; } else { level = 'Amat Cemerlang'; color = colors[4]; } tableHTML += `<tr><td>${name}</td><td>${avgScores.komunikasi}</td><td>${avgScores.interpersonal}</td><td>${avgScores.praktikal}</td><td>${avgScores.autonomi}</td><td>${avgScores.kepimpinan}</td><td><strong>${totalScore.toFixed(2)}%</strong></td><td style="background-color:${color}; color:${totalScore < 65 ? 'black' : 'white'};">${level}</td></tr>`; } tableHTML += '</tbody></table>'; container.innerHTML = tableHTML; const studentSelect = document.getElementById('studentChartSelect'); studentSelect.innerHTML = '<option value="">Pilih Pelajar</option>'; Object.keys(reportData).sort().forEach(name => { studentSelect.innerHTML += `<option value="${name}">${name}</option>`; }); chartSection.style.display = 'block'; } catch (error) { console.error("Error generating report: ", error); container.innerHTML = '<p>Gagal menjana laporan.</p>'; } finally { reportBtn.disabled = false; reportBtn.textContent = 'Jana Laporan Rumusan'; } }
        function generateRadarChart() { const studentName = document.getElementById('studentChartSelect').value; const chartCanvas = document.getElementById('myRadarChart'); if (myRadarChart) myRadarChart.destroy(); if (!studentName) return; const studentScores = reportData[studentName]; if (!studentScores) return; const labels = ['Komunikasi', 'Interpersonal', 'Praktikal', 'Autonomi', 'Kepimpinan']; const data = labels.map(label => studentScores[label.toLowerCase().split(' ')[0]]); myRadarChart = new Chart(chartCanvas, { type: 'radar', data: { labels: labels, datasets: [{ label: `Purata Markah untuk ${studentName}`, data: data, fill: true, backgroundColor: 'rgba(0, 123, 255, 0.2)', borderColor: 'rgba(0, 123, 255, 1)', pointBackgroundColor: 'rgba(0, 123, 255, 1)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgba(0, 123, 255, 1)' }] }, options: { scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 5, ticks: { stepSize: 1 } } }, elements: { line: { borderWidth: 3 } } } }); }
        async function loadMembers() { const groupNo = document.getElementById('groupSelect').value; if (!groupNo) { alert('Sila pilih kumpulan anda.'); return; } const icNo = document.getElementById('icNo').value.trim().replace(/-/g, ''); if (!icNo) { alert('Sila masukkan No. Kad Pengenalan anda.'); return; } const loadBtn = document.getElementById('loadBtn'); loadBtn.disabled = true; loadBtn.textContent = 'Mengesahkan...'; try { const securityCheckQuery = await db.collection('pelajar').where('kumpulan', '==', groupNo).where('kp', '==', icNo).get(); if (securityCheckQuery.empty) { alert('Pengesahan gagal. No. KP anda tidak ditemui dalam kumpulan ini.'); throw new Error("Security check failed"); } const userDoc = securityCheckQuery.docs[0]; currentUserData = { id: userDoc.id, ...userDoc.data() }; loadBtn.textContent = 'Menyemak Rekod...'; const submissionCheckQuery = await db.collection('penilaian').where('kumpulan', '==', groupNo).where('penilai_kp', '==', icNo).get(); const hasSubmitted = !submissionCheckQuery.empty; const membersQuery = await db.collection('pelajar').where('kumpulan', '==', groupNo).get(); let allMemberNames = new Set(); membersQuery.forEach(doc => allMemberNames.add(doc.data().nama)); const sortedAllMembers = Array.from(allMemberNames).sort(); const memberListSection = document.getElementById('memberList'); memberListSection.innerHTML = `<h2 id="assessmentHeader">Borang Penilaian Kumpulan ${groupNo}</h2><div id="submissionStatus" style="display:none;"></div><h3>Senarai Ahli Kumpulan Anda</h3><ul id="members">${sortedAllMembers.map(m => `<li>${m}</li>`).join('')}</ul><form id="assessmentForm"></form>`; currentMembers = sortedAllMembers.filter(member => member !== currentUserData.nama); const form = document.getElementById('assessmentForm'); const skills = [ { id: 'komunikasi', name: 'Kemahiran Komunikasi' }, { id: 'interpersonal', name: 'Kemahiran Interpersonal' }, { id: 'praktikal', name: 'Kemahiran Praktikal' }, { id: 'autonomi', name: 'Autonomi dan Tanggungjawab' }, { id: 'kepimpinan', name: 'Kepimpinan' } ]; const rubricDetails = { komunikasi: '<ul><li><strong>1 (Lemah):</strong> Tidak berkomunikasi atau sukar difahami.</li><li><strong>2 (Sederhana):</strong> Menyampaikan idea asas tetapi kurang jelas.</li><li><strong>3 (Kepujian):</strong> Berkomunikasi dengan jelas & mengambil bahagian.</li><li><strong>4 (Cemerlang):</strong> Berkomunikasi dengan sangat jelas, efektif, & meyakinkan.</li><li><strong>5 (Amat Cemerlang):</strong> Komunikasi luar biasa, mendengar aktif & memimpin perbincangan.</li></ul>', interpersonal: '<ul><li><strong>1 (Lemah):</strong> Tidak membina hubungan atau menimbulkan konflik.</li><li><strong>2 (Sederhana):</strong> Interaksi minimum dan tidak konsisten.</li><li><strong>3 (Kepujian):</strong> Bekerjasama dengan baik & menghormati pandangan lain.</li><li><strong>4 (Cemerlang):</strong> Membina hubungan kukuh & memberi galakan.</li><li><strong>5 (Amat Cemerlang):</strong> Hubungan sangat kukuh, menjadi pengantara & menjaga keharmonian.</li></ul>', praktikal: '<ul><li><strong>1 (Lemah):</strong> Tidak melaksanakan tugas atau hasil sangat lemah.</li><li><strong>2 (Sederhana):</strong> Melaksanakan tugas asas dengan banyak bimbingan.</li><li><strong>3 (Kepujian):</strong> Melaksanakan tugas dengan baik mengikut arahan.</li><li><strong>4-Cemerlang):</strong> Melaksanakan tugas dengan cekap, teliti & pengawasan minimum.</li><li><strong>5 (Amat Cemerlang):</strong> Melaksanakan tugas dengan inovatif & kemahiran teknikal tinggi.</li></ul>', autonomi: '<ul><li><strong>1 (Lemah):</strong> Sangat bergantung & mengelak tanggungjawab.</li><li><strong>2 (Sederhana):</strong> Sedikit autonomi & perlu peringatan.</li><li><strong>3 (Kepujian):</strong> Bertanggungjawab & selesaikan tugas ikut tempoh.</li><li><strong>4 (Cemerlang):</strong> Autonomi tinggi, proaktif & boleh dipercayai.</li><li><strong>5 (Amat Cemerlang):</strong> Kepimpinan autonomi, ambil inisiatif & bertanggungjawab sepenuhnya.</li></ul>', kepimpinan: '<ul><li><strong>1 (Lemah):</strong> Tidak menunjukkan ciri kepimpinan & pasif.</li><li><strong>2 (Sederhana):</strong> Kepimpinan minimum, hanya apabila diminta.</li><li><strong>3 (Kepujian):</strong> Boleh memimpin tugas kecil & beri arahan jelas.</li><li><strong>4 (Cemerlang):</strong> Memimpin dengan efektif, agih tugas adil & beri motivasi.</li><li><strong>5 (Amat Cemerlang):</strong> Sumber inspirasi, memimpin dengan teladan & menyelesaikan konflik.</li></ul>' }; skills.forEach(skill => { const tableRows = currentMembers.map(member => `<tr><td>${member}</td><td><select><option value="">Pilih</option>${[1,2,3,4,5].map(v => `<option value="${v}">${v}</option>`).join('')}</select></td></tr>`).join(''); form.innerHTML += `<div class="section"><h2>${skill.name}</h2><div class="rubric-details"><p><strong>Kriteria Penilaian:</strong></p>${rubricDetails[skill.id]}</div><div class="table-responsive"><table><thead><tr><th>Nama Ahli</th><th>Markah (1-5)</th></tr></thead><tbody id="table-${skill.id}">${tableRows}</tbody></table></div></div>`; }); form.innerHTML += `<button type="submit">Hantar & Simpan Penilaian</button>`; form.addEventListener('submit', handleFormSubmit); memberListSection.style.display = 'block'; if (hasSubmitted) { const statusDiv = document.getElementById('submissionStatus'); statusDiv.textContent = 'Anda telah pun menghantar penilaian untuk kumpulan ini.'; statusDiv.style.display = 'block'; form.querySelectorAll('select, button').forEach(el => el.disabled = true); } } catch (error) { console.error("Ralat: ", error); } finally { loadBtn.disabled = false; loadBtn.textContent = 'Sahkan Diri'; } }
        function handleFormSubmit(e) { e.preventDefault(); let allFilled = true; currentMembers.forEach((member, index) => { const tableIds = ['table-komunikasi', 'table-interpersonal', 'table-praktikal', 'table-autonomi', 'table-kepimpinan']; for(const tableId of tableIds) { const selectValue = document.querySelector(`#${tableId} tr:nth-child(${index + 1}) select`).value; if (selectValue === "") { allFilled = false; break; } } }); if (!allFilled) { alert('Sila lengkapkan semua markah untuk semua ahli sebelum menghantar.'); return; } document.getElementById('confirmationModal').classList.add('visible'); }
        function closeConfirmationModal() { document.getElementById('confirmationModal').classList.remove('visible'); }
        function handleFinalSubmit() { const confirmBtn = document.getElementById('confirmBtn'); const cancelBtn = document.getElementById('cancelBtn'); confirmBtn.disabled = true; cancelBtn.disabled = true; confirmBtn.textContent = 'Menghantar...'; const assessments = []; const groupNo = document.getElementById('groupSelect').value; const timestamp = new Date(); currentMembers.forEach((member, index) => { const scores = { komunikasi: parseInt(document.querySelector(`#table-komunikasi tr:nth-child(${index + 1}) select`).value), interpersonal: parseInt(document.querySelector(`#table-interpersonal tr:nth-child(${index + 1}) select`).value), praktikal: parseInt(document.querySelector(`#table-praktikal tr:nth-child(${index + 1}) select`).value), autonomi: parseInt(document.querySelector(`#table-autonomi tr:nth-child(${index + 1}) select`).value), kepimpinan: parseInt(document.querySelector(`#table-kepimpinan tr:nth-child(${index + 1}) select`).value) }; assessments.push({ nama_dinilai: member, kumpulan: groupNo, skor: scores, tarikhPenilaian: timestamp, penilai_kp: currentUserData.kp }); }); const batch = db.batch(); assessments.forEach(assessment => { const docRef = db.collection('penilaian').doc(); batch.set(docRef, assessment); }); batch.commit().then(() => { closeConfirmationModal(); document.getElementById('successModal').classList.add('visible'); setTimeout(() => { window.location.reload(); }, 3000); }).catch(error => { alert("Gagal menghantar penilaian. Sila cuba lagi."); confirmBtn.disabled = false; cancelBtn.disabled = false; confirmBtn.textContent = 'Ya, Pasti'; closeConfirmationModal(); }); }
        function processExcel() { const fileInput = document.getElementById('uploadExcel'); const file = fileInput.files[0]; if (!file) { alert('Sila pilih fail Excel.'); return; } const processBtn = document.getElementById('processBtn'); processBtn.disabled = true; processBtn.textContent = 'Memuat Naik...'; const reader = new FileReader(); reader.onload = function(e) { const workbook = XLSX.read(e.target.result, { type: 'binary' }); const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]); if (json.length === 0 || !json[0]['Nama Pelajar'] || !json[0]['Kumpulan'] || !json[0]['No. KP']) { alert('Ralat: Pastikan fail Excel mempunyai lajur "Nama Pelajar", "Kumpulan", dan "No. KP".'); processBtn.disabled = false; processBtn.textContent = 'Muat Naik Senarai Pelajar'; return; } const batch = db.batch(); json.forEach(student => { const studentKp = (student['No. KP'] || '').toString().replace(/-/g, ''); if(studentKp) { const docRef = db.collection('pelajar').doc(studentKp); const studentData = { nama: student['Nama Pelajar'], kumpulan: student['Kumpulan'].toString(), kp: studentKp }; batch.set(docRef, studentData, { merge: true }); } }); batch.commit().then(() => { alert(`${json.length} rekod pelajar telah berjaya diproses!`); fileInput.value = ''; populateGroupDropdownForLogin(); }).catch(err => alert("Gagal menyimpan data.")).finally(() => { processBtn.disabled = false; processBtn.textContent = 'Muat Naik Senarai Pelajar'; }); }; reader.readAsBinaryString(file); }
        async function exportScoresToExcel() { const exportBtn = document.getElementById('exportBtn'); exportBtn.disabled = true; exportBtn.textContent = 'Menjana...'; try { const snapshot = await db.collection('penilaian').get(); if (snapshot.empty) { alert('Tiada data penilaian ditemui.'); return; } const dataForExcel = snapshot.docs.map(doc => { const data = doc.data(); const totalScore = (data.skor.komunikasi/5*30)+(data.skor.interpersonal/5*30)+(data.skor.praktikal/5*15)+(data.skor.autonomi/5*15)+(data.skor.kepimpinan/5*10); return { "Nama Dinilai": data.nama_dinilai, "Kumpulan": data.kumpulan, "No. KP Penilai": data.penilai_kp, "Tarikh Dinilai": data.tarikhPenilaian.toDate().toLocaleString('ms-MY'), "Skor Komunikasi": data.skor.komunikasi, "Skor Interpersonal": data.skor.interpersonal, "Skor Praktikal": data.skor.praktikal, "Skor Autonomi": data.skor.autonomi, "Skor Kepimpinan": data.skor.kepimpinan, "Jumlah Markah (%)": totalScore.toFixed(2) }; }); const worksheet = XLSX.utils.json_to_sheet(dataForExcel); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Markah"); XLSX.writeFile(workbook, `Laporan Penuh Penilaian - ${new Date().toISOString().slice(0,10)}.xlsx`); } catch (err) { alert("Gagal memuat turun laporan."); } finally { exportBtn.disabled = false; exportBtn.textContent = 'Muat Turun Laporan Penuh (Excel)'; } }
    </script>
</body>
</html>

