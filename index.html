<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borang Penilaian Kumpulan - Program Bina Insan Guru</title>
    <script type="text/javascript" src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1, h2 { text-align: center; color: #333; }
        .section { margin-bottom: 30px; padding: 15px; background-color: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
        .rubric { font-size: 0.9em; margin-top: 10px; }
        .rubric span { padding: 5px; border-radius: 4px; margin-right: 5px; }
        .lemak { background-color: red; color: white; }
        .sederhana { background-color: orange; color: white; }
        .kepuasan { background-color: yellow; color: black; }
        .cemerlang { background-color: lightgreen; color: black; }
        .amat { background-color: green; color: white; }
        #memberList { display: none; }
        button { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #45a049; }
        input[type="file"], input[type="text"], input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Borang Penilaian Kumpulan Berdasarkan HP untuk Program Bina Insan Guru</h1>
    
    <div class="section">
        <h2>Muat Naik Senarai Pelajar (Excel)</h2>
        <input type="file" id="uploadExcel" accept=".xlsx, .xls">
        <button onclick="processExcel()">Proses & Simpan Pelajar ke Pangkalan Data</button>
        <p>Format Excel mestilah mempunyai header: Nama Pelajar, No. KP, AGiliran, Kelas, Kumpulan</p>
    </div>
    
    <div class="section">
        <label for="groupNo">No Kumpulan:</label>
        <input type="text" id="groupNo" required>
        <button onclick="loadMembers()">Muat Senarai Ahli</button>
    </div>
    
    <div id="memberList">
        <h2>Senarai Ahli Kumpulan</h2>
        <ul id="members"></ul>
        
        <form id="assessmentForm">
            <!-- Kriteria 1: HP3 Kemahiran Komunikasi -->
            <div class="section">
                <h2>HP3 Kemahiran Komunikasi (Wajaran: 30%)</h2>
                <div class="rubric">
                    <span class="lemak">1: Lemah</span> <span class="sederhana">2: Sederhana</span> <span class="kepuasan">3: Kepuasan</span> <span class="cemerlang">4: Cemerlang</span> <span class="amat">5: Amat Cemerlang</span>
                </div>
                <table>
                    <thead><tr><th>Nama Ahli</th><th>Markah (1-5)</th></tr></thead>
                    <tbody id="table-komunikasi"></tbody>
                </table>
            </div>
            
            <!-- Kriteria 2: HP4 Kemahiran Interpersonal -->
            <div class="section">
                <h2>HP4 Kemahiran Interpersonal (Wajaran: 30%)</h2>
                <div class="rubric">
                     <span class="lemak">1: Lemah</span> <span class="sederhana">2: Sederhana</span> <span class="kepuasan">3: Kepuasan</span> <span class="cemerlang">4: Cemerlang</span> <span class="amat">5: Amat Cemerlang</span>
                </div>
                <table>
                    <thead><tr><th>Nama Ahli</th><th>Markah (1-5)</th></tr></thead>
                    <tbody id="table-interpersonal"></tbody>
                </table>
            </div>
            
            <!-- Kriteria 3: HP8 Kemahiran Praktikal -->
            <div class="section">
                <h2>HP8 Kemahiran Praktikal (Wajaran: 15%)</h2>
                <div class="rubric">
                     <span class="lemak">1: Lemah</span> <span class="sederhana">2: Sederhana</span> <span class="kepuasan">3: Kepuasan</span> <span class="cemerlang">4: Cemerlang</span> <span class="amat">5: Amat Cemerlang</span>
                </div>
                <table>
                    <thead><tr><th>Nama Ahli</th><th>Markah (1-5)</th></tr></thead>
                    <tbody id="table-praktikal"></tbody>
                </table>
            </div>
            
            <!-- Kriteria 4: HP9 Autonomi dan Tanggungjawab -->
            <div class="section">
                <h2>HP9 Autonomi dan Tanggungjawab (Wajaran: 15%)</h2>
                <div class="rubric">
                     <span class="lemak">1: Lemah</span> <span class="sederhana">2: Sederhana</span> <span class="kepuasan">3: Kepuasan</span> <span class="cemerlang">4: Cemerlang</span> <span class="amat">5: Amat Cemerlang</span>
                </div>
                <table>
                    <thead><tr><th>Nama Ahli</th><th>Markah (1-5)</th></tr></thead>
                    <tbody id="table-autonomi"></tbody>
                </table>
            </div>
            
            <!-- Kriteria 5: HP10 Kepimpinan -->
            <div class="section">
                <h2>HP10 Kepimpinan (Wajaran: 10%)</h2>
                <div class="rubric">
                     <span class="lemak">1: Lemah</span> <span class="sederhana">2: Sederhana</span> <span class="kepuasan">3: Kepuasan</span> <span class="cemerlang">4: Cemerlang</span> <span class="amat">5: Amat Cemerlang</span>
                </div>
                <table>
                    <thead><tr><th>Nama Ahli</th><th>Markah (1-5)</th></tr></thead>
                    <tbody id="table-kepimpinan"></tbody>
                </table>
            </div>

            <div id="totalSection" class="section" style="display: none;">
                <h2>Jumlah Markah</h2>
                <table>
                    <thead><tr><th>Nama Ahli</th><th>Jumlah (%)</th><th>Tahap</th></tr></thead>
                    <tbody id="totalTable"></tbody>
                </table>
            </div>
            
            <button type="button" onclick="calculateTotals()">Kira Jumlah Markah (Papar Sahaja)</button>
            <button type="submit">Hantar & Simpan Penilaian</button>
        </form>
    </div>

    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // --- KOD FIREBASE ANDA TELAH DIMASUKKAN DI SINI ---
        const firebaseConfig = {
            apiKey: "AIzaSyA7oRO1-G8zhIp6eHNLcDpw0oNGcMBPxoE",
            authDomain: "penilaiankumpulan.firebaseapp.com",
            projectId: "penilaiankumpulan",
            storageBucket: "penilaiankumpulan.appspot.com",
            messagingSenderId: "288651360802",
            appId: "1:288651360802:web:62f1e2fe94a387ca3fa87b",
            measurementId: "G-12S4PCL2ED"
        };
        // --------------------------------------------------

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Inisialisasi Firestore

        let currentMembers = []; // Simpan ahli semasa
        const colors = ['red', 'orange', 'yellow', 'lightgreen', 'green'];

        function processExcel() {
            if (typeof XLSX === 'undefined') {
                alert('Perpustakaan SheetJS tidak dimuat.');
                return;
            }
            const fileInput = document.getElementById('uploadExcel');
            const file = fileInput.files[0];
            if (!file) {
                alert('Sila pilih fail Excel terlebih dahulu.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet); // Lebih mudah guna format JSON

                if (json.length === 0 || !json[0]['Nama Pelajar'] || !json[0]['Kumpulan']) {
                    alert('Fail Excel tidak mempunyai header yang betul. Pastikan ada "Nama Pelajar" dan "Kumpulan".');
                    return;
                }

                // Gunakan batch write untuk simpan semua pelajar sekali gus (lebih efisien)
                const batch = db.batch();
                json.forEach(student => {
                    const studentData = {
                        nama: student['Nama Pelajar'],
                        kumpulan: student['Kumpulan'].toString(),
                        kp: student['No. KP'] || '',
                        agiliran: student['AGiliran'] || '',
                        kelas: student['Kelas'] || ''
                    };
                    const docRef = db.collection('pelajar').doc(); // Cipta rujukan dokumen baru
                    batch.set(docRef, studentData);
                });

                batch.commit().then(() => {
                    alert(`${json.length} data pelajar telah berjaya disimpan ke dalam pangkalan data Firebase!`);
                }).catch(error => {
                    console.error("Ralat semasa menyimpan data: ", error);
                    alert("Gagal menyimpan data ke pangkalan data.");
                });
            };
            reader.readAsBinaryString(file);
        }

        async function loadMembers() {
            const groupNo = document.getElementById('groupNo').value.trim();
            if (!groupNo) {
                alert('Sila masukkan nombor kumpulan.');
                return;
            }

            // Dapatkan ahli dari Firestore
            const membersListElem = document.getElementById('members');
            membersListElem.innerHTML = '<i>Mencari ahli...</i>';
            currentMembers = [];

            try {
                const querySnapshot = await db.collection('pelajar').where('kumpulan', '==', groupNo).get();
                if (querySnapshot.empty) {
                    alert('Tiada pelajar ditemui untuk kumpulan ini.');
                    membersListElem.innerHTML = '';
                    return;
                }

                querySnapshot.forEach(doc => {
                    currentMembers.push(doc.data().nama);
                });
                
                currentMembers.sort(); // Susun nama mengikut abjad

                // Paparkan nama
                membersListElem.innerHTML = '';
                currentMembers.forEach(member => {
                    const li = document.createElement('li');
                    li.textContent = member;
                    membersListElem.appendChild(li);
                });

                // Populate tables
                const tables = ['table-komunikasi', 'table-interpersonal', 'table-praktikal', 'table-autonomi', 'table-kepimpinan'];
                tables.forEach(tableId => {
                    const tbody = document.getElementById(tableId);
                    tbody.innerHTML = '';
                    currentMembers.forEach(member => {
                        const tr = document.createElement('tr');
                        const tdName = document.createElement('td');
                        tdName.textContent = member;
                        tdName.dataset.memberName = member; // Tambah data attribute untuk rujukan

                        const tdScore = document.createElement('td');
                        const select = document.createElement('select');
                        select.innerHTML = '<option value="">Pilih</option>';
                        for (let i = 1; i <= 5; i++) {
                            const option = document.createElement('option');
                            option.value = i;
                            option.textContent = i;
                            select.appendChild(option);
                        }
                        select.onchange = function() {
                            const val = parseInt(this.value);
                            tdScore.style.backgroundColor = !isNaN(val) ? colors[val - 1] : '';
                        };
                        tdScore.appendChild(select);
                        tr.appendChild(tdName);
                        tr.appendChild(tdScore);
                        tbody.appendChild(tr);
                    });
                });

                document.getElementById('memberList').style.display = 'block';

            } catch (error) {
                console.error("Ralat memuatkan ahli: ", error);
                alert("Gagal memuatkan senarai ahli dari pangkalan data.");
            }
        }

        function calculateTotals() {
            const weights = {
                'table-komunikasi': 0.30,
                'table-interpersonal': 0.30,
                'table-praktikal': 0.15,
                'table-autonomi': 0.15,
                'table-kepimpinan': 0.10
            };
            const totalTable = document.getElementById('totalTable');
            totalTable.innerHTML = '';

            let allFilled = true;

            currentMembers.forEach((member, index) => {
                let totalScore = 0;
                
                for (const tableId in weights) {
                    const select = document.querySelector(`#${tableId} tr:nth-child(${index + 1}) select`);
                    const score = parseInt(select.value);
                    if (isNaN(score)) {
                        allFilled = false;
                    }
                    totalScore += (score / 5) * (weights[tableId] * 100);
                }

                if (!allFilled) return;

                let level = '';
                let color = '';
                if (totalScore < 40) { level = 'Lemah'; color = 'red'; } 
                else if (totalScore < 50) { level = 'Sederhana'; color = 'orange'; } 
                else if (totalScore < 65) { level = 'Kepuasan'; color = 'yellow'; } 
                else if (totalScore < 80) { level = 'Cemerlang'; color = 'lightgreen'; } 
                else { level = 'Amat Cemerlang'; color = 'green'; }

                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${member}</td><td>${totalScore.toFixed(2)}%</td><td style="background-color:${color};">${level}</td>`;
                totalTable.appendChild(tr);
            });
            
            if (!allFilled) {
                alert('Sila isi semua markah terlebih dahulu untuk mengira jumlah.');
                totalTable.innerHTML = '';
                return;
            }
            
            document.getElementById('totalSection').style.display = 'block';
        }

        document.getElementById('assessmentForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Halang borang dari refresh halaman
            
            let allFilled = true;
            const assessments = [];
            const groupNo = document.getElementById('groupNo').value.trim();
            const timestamp = new Date(); // Catat masa penilaian dibuat

            currentMembers.forEach((member, index) => {
                const scores = {
                    komunikasi: parseInt(document.querySelector(`#table-komunikasi tr:nth-child(${index + 1}) select`).value),
                    interpersonal: parseInt(document.querySelector(`#table-interpersonal tr:nth-child(${index + 1}) select`).value),
                    praktikal: parseInt(document.querySelector(`#table-praktikal tr:nth-child(${index + 1}) select`).value),
                    autonomi: parseInt(document.querySelector(`#table-autonomi tr:nth-child(${index + 1}) select`).value),
                    kepimpinan: parseInt(document.querySelector(`#table-kepimpinan tr:nth-child(${index + 1}) select`).value)
                };

                if (Object.values(scores).some(isNaN)) {
                    allFilled = false;
                }
                
                assessments.push({
                    nama: member,
                    kumpulan: groupNo,
                    skor: scores,
                    tarikhPenilaian: timestamp
                });
            });

            if (!allFilled) {
                alert('Sila lengkapkan semua markah sebelum menghantar.');
                return;
            }
            
            // Simpan setiap penilaian ke Firestore
            const batch = db.batch();
            assessments.forEach(assessment => {
                const docRef = db.collection('penilaian').doc(); // Cipta dokumen baru dalam koleksi 'penilaian'
                batch.set(docRef, assessment);
            });

            batch.commit().then(() => {
                alert('Penilaian berjaya dihantar dan disimpan ke pangkalan data!');
                calculateTotals(); // Papar semula jadual jumlah
            }).catch(error => {
                console.error("Ralat semasa menghantar penilaian: ", error);
                alert("Gagal menghantar penilaian.");
            });
        });
    </script>
</body>
</html>
